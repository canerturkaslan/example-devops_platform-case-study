pipeline {
  agent {
    kubernetes {
      yamlFile './app/builder.yaml'
    }
  }
  
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    
    stage('Build and Push') {
      environment {
                PATH = "/busybox:/kaniko:$PATH"
              }      
    steps {
      container(name: 'kaniko', shell: '/busybox/sh') {
        // Kaniko ile Docker imajını build ve push işlemi
        script {
          def dockerImage = 'canerturkaslan/flask-app'
          def dockerfile = '/app/Dockerfile'
          def buildNumber = env.BUILD_NUMBER ?: '1' 
          def dockerTag = "${dockerImage}:0.${buildNumber}"           

          sh "ls -ltra && pwd"
          sh '''
          /kaniko/executor --dockerfile `pwd`/app/Dockerfile \
                           --context `pwd` \
                           --destination==${dockerImage}:0.${buildNumber}
          '''
        }
      }
    }
  }    
 

  }
}

